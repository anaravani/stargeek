'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[62],{1534:function(r,C,a){a.r(C);var c=a(35),b=a(149),e=a(6);r=a(0);var f=a(15),d=a(88);class h{constructor(B,E,I,S,J,K){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=B;this.WebAffinitizedUrl=E;this.PolicyCookie=I;this.PolicyCookieTTL=S;this.WasServiceDown=J;this.AffinitizedUrl=K}}Object(r.a)(h,
"SafeLinksData",null,[]);class l{constructor(B,E){this.tHc=B;this.stopwatch=E}}Object(r.a)(l,"SafeLinksGetUrlReputationRequestData",null,[]);var k=a(43),u=a(41);class v{constructor(B,E,I,S){this.Ra=B;this.Ah=E;this.UHg=I;v.ti=S}mha(B,E,I){try{var S=null;v.ti&&(S=v.ti.Fd("WebServiceCall","SafeLinksGetUrlReputation"));const J=new l(E,S);S={};S.AffinitizedUrl=B;S.TargetUrl=E;S.PolicyCookie=I;const K=k.c(S);this.Ah.Sn(this.UHg,2,K,null,!1,2,Object(d.a)(this,this.C7i,"onGetUrlReputationSuccessCallback"),
Object(d.a)(this,this.B7i,"onGetUrlReputationFailureCallback"),J,void 0,void 0,3E3,3E3,"36");return!0}catch(J){f.ULS.sendTraceTag(588788033,378,10,J.message)}return!1}C7i(B){let E="OnGetUrlReputationSuccessCallback: ",I=10;const S=B.data.state;try{const J=k.b(B.data.Pe).reputationResults[0],K=J.navigateUrl.length,R=S.tHc.length,Z=J.navigateUrl===S.tHc;J.navigateUrl&&0<J.navigateUrl.length&&(S.tHc=J.navigateUrl);E+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
B.data.httpStatus,J.verdict,R.toString(),K.toString(),Z.toString());I=50}catch(J){E+=String.format("Exception {0}",J.message)}this.Zhf(S,E,I)}B7i(B){let E="OnGetUrlReputationFailureCallback: ";const I=B.data.state;try{E+=String.format("HttpStatus {0}",B.data.httpStatus)}catch(S){E+=String.format("Exception {0}",S.message)}this.Zhf(I,E,10)}Zhf(B,E,I){B.stopwatch&&(B.stopwatch.stop(),B.stopwatch=null);f.ULS.sendTraceTag(588788034,378,I,E);u.a.Vf(B.tHc,void 0,"noopener,noreferrer","SafeLinksNav")}}v.ti=
null;Object(r.a)(v,"SafeLinksNavigationHelper",null,[]);var x;(function(B){B[B.enabledByPolicy=0]="enabledByPolicy";B[B.disabledByPolicy=1]="disabledByPolicy";B[B.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";B[B.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(x||(x={}));Object(r.b)("SafeLinksNavigationState",x);var w=a(103),m=a(148),t=a(823),z=a(265),y=a(251),D=a(716),H=a(31),F=a(173),G=a(184);class L{constructor(B,E,I,S=!1,J=null,K=null){this.VGa=this.UGa=0;this.lFb=
this.WYb=!1;this.Sta=null;this.j_a=!0;this.x1b=null;f.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.Ra=B;this.Ah=E;this.psa=I;L.ti=K;this.aRg=S?this.Ra.Va("SafeLinksHandlerWebServiceBase"):this.Ra.Va("WebServiceBase");this.KQg=this.Ra.Va("SafeLinksHashedUserId");this.dmk=this.Ra.Va("SafeLinksWorkloadIdHeaderValue");this.v_b=this.Ra.Ae("SafeLinksMaxGetPolicyBootRetries",2);this.w_b=this.Ra.Ae("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.AZb=this.isSafeLinksEnabledForUser();
this.zZb=this.AHi();L.Ute=this.Ra.Va("UserPrincipalName")||"";L.Use=this.Ra.Va("TenantId")||"";f.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.AZb,this.zZb);if(this.AZb&&this.zZb){E=(B=this.Xxa())?B.IsSafeLinksEnabled.toLowerCase():"";I=this.wyd();f.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",E,I);var R=!B||"unknown"===E||B.WasServiceDown||I,Z=m.a.zt();Z&&(Z.set("shouldGetSafeLinksDataFromServer",
R.toString()),Z.set("isSafeLinksEnabledCacheValue",E.toString()));J?(this.j_a=!1,J.execute(P=>{P.isFeatureEnabled("MsoUrlreputation",!0).then(V=>{this.j_a=V;Z.set("isUserLicensedForSafeLinks",this.j_a.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",Z);this.j_a&&R&&this.Cic(!0);return null})})):(w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",Z),R&&this.Cic(!0))}}get appName(){return this.psa}get mLc(){return this.aRg}get userId(){return this.KQg}get cgf(){try{if(""===
L.mRc){const B={};B["X-AppName"]=this.appName;B["X-AppVersion"]=e.AFrameworkApplication.buildVersion;B.OS=this.Ra.Va("PlatformNameAndVersion")||"";const E=JSON.stringify(B);L.mRc=window.self.btoa(E)}}catch(B){f.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",B.message)}return L.mRc}get ybi(){const B=this.mLc?this.mLc+"/":"",E=new z.QueryStringBuilder("SafeLinksHandler.ashx");E.Tj("app",this.appName);this.Ra.ra("SafeLinksUseDebugHeader")&&E.Tj("action","debug");
this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&E.Tj("s2satpop","1");this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&E.Tj("s2se03","1");return String.format("{0}{1}&{2}",B,E.toString(),e.AFrameworkApplication.oj)}get Mhi(){const B=this.mLc?this.mLc+"/":"",E=new z.QueryStringBuilder("SafeLinksHandler.ashx");E.Tj("app",this.appName);this.Ra.ra("SafeLinksUseDebugHeader")&&E.Tj("action","debug");this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&E.Tj("s2satpop","1");this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&E.Tj("s2saat","1");this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&E.Tj("s2se03","1");this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&E.Tj("sladpar",this.cgf);E.Tj("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",B,E.toString(),e.AFrameworkApplication.oj)}get xYi(){L.DYc||(L.DYc=new v(this.Ra,
this.Ah,this.Mhi,L.ti));return L.DYc}mha(B){if(!B)return f.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var E=this.ADi(B);f.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",E,this.AZb,this.zZb,this.j_a);if(!(E&&this.AZb&&this.zZb&&this.j_a))return!1;E=0;const I=({state:E}=this.PWj()).returnValue;f.ULS.sendTraceTag(595079385,378,
50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",x[E]);const S=m.a.zt();S&&S.set("SafeLinksNavigationState",x[E]);w.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",S);if(!I)return 2!==E&&3!==E||w.Health.instance.recordKpiFailure("SafeLinksNavigations",x[E],!1,!0,null),!1;f.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.XWj())return this.wyd()?!1:this.xYi.mha(this.E_h(),B,this.edf());if(!this.wyd())return this.$qg(B),!0;this.Sta=
B;f.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.lFb=!1;this.Cic();return!0}ADi(B){B=B.toLowerCase();const E=this.Ra.Tw("SafeLinksUnsupportedProtocols");if(E)for(let I=0;I<E.length;I++)if(B.startsWith(E[I]))return!1;return!0}Cic(B=!1){var E=m.a.zt();E&&E.set("isOnBootRequest",B.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",E);w.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",
E);E=this.Fad("SafeLinksGetPolicy");this.Ah.Sn(this.ybi,1,null,null,!0,2,Object(d.a)(this,this.cei,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(d.a)(this,this.bei,"getSafeLinksDataFromServer_OnFailureCallback"),E,void 0,void 0,void 0,void 0,"23");this.lFb=B;this.WYb=!0;B?this.UGa++:this.VGa++}cei(B){let E=y.a.sZi,I="";try{this.WYb=this.lFb=!1;var S=B.data.state;const ea=({stopwatch:S}=this.wGc(S)).returnValue,aa=Object.assign(new G.a,{durationMs:ea});w.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
aa);f.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",B.data.httpStatus,B.data.Pe.length,ea);if(B.data.httpStatus!==y.a.xK)I="Unexpected httpStatus: "+B.data.httpStatus.toString();else{S=null;try{S=k.b(B.data.Pe)}catch(ia){I="Exception:"+ia.toString()+" deserializing response";return}if(S){var J=S.IsSafeLinksEnabled;if(void 0===J||null===J||0>=J.length)I="Invalid isSafeLinksEnabledString";else{f.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",J);var K=L.nMd(J);if(void 0===S.WebAffinitizedUrl||null===S.WebAffinitizedUrl||0>=S.WebAffinitizedUrl.length)I="Invalid WebAffinitizedUrl";else if(void 0===S.PolicyCookie||null===S.PolicyCookie||0>=S.PolicyCookie.length)I="Invalid PolicyCookie";else if(void 0===S.PolicyCookieTTL||null===S.PolicyCookieTTL)I="Invalid PolicyCookieTTL";else{var R=S.WebAffinitizedUrl,Z=S.PolicyCookie,P=S.AffinitizedUrl,V=new Date;V.setMinutes(V.getMinutes()+(5<S.PolicyCookieTTL?
S.PolicyCookieTTL-5:0));var Ea=V.getTime(),oa=new h(J,R,Z,Ea,!1,P);this.Jcg(oa);E=B.data.httpStatus;this.Sta&&(K?(this.$qg(this.Sta),this.VGa=this.UGa=0):(f.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),u.a.aS(this.Sta)),this.Sta=null)}}}else I="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(ea){I="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
ea.toString()}finally{E!==y.a.xK&&this.Yhf(E,I)}}bei(B){this.WYb=!1;let E=500,I="";try{let S=B.data.state;const J=({stopwatch:S}=this.wGc(S)).returnValue,K=Object.assign(new G.a,{durationMs:J});E=B.data.httpStatus;w.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+E.toString(),!1,!0,K);I="Request Failed, Status="+D.a[B.data.status]+" Duration: "+J}catch(S){I="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+S.toString()}finally{this.Yhf(E,I)}}Yhf(B,E=""){try{if(f.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",B,E),this.UGa<this.v_b&&this.VGa<this.w_b)this.Cic(this.lFb);else{this.lFb=!1;f.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.UGa,this.VGa,B,E);E=null;const I=m.a.zt();I&&(I.set("HttpStatus",B.toString()),E=Object.assign(new G.a,{extendedProperties:I}));w.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,E);const S=new h("false","","",0,!0,"");this.Jcg(S);this.Sta&&(f.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),u.a.aS(this.Sta),this.Sta=null)}}catch(I){f.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",I.toString())}}$qg(B){const E=this.edf(),I=this.Aii(),S={};S.Url=B;S.SafeLinksCookie=
E;S.CorrelationId=F.a.create().toString();S.WorkloadId=this.dmk;S.UserAgentInfo=H.a.yva+"|"+this.appName;this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&(S.User=L.Ute,S.TenantId=L.Use,S.AdditionalProperties=this.cgf);f.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",S.CorrelationId);u.a.Cxc(u.a.aZ(4),I,S)}isSafeLinksEnabledForUser(){const B=this.Ra.Va("IsSafeLinksEnabledForUser");return B?L.nMd(B):!1}AHi(){const B=this.Ra.Tw("SafeLinksDisabledBrowsers");
if(H.a.wC){if(this.Ra.Lq("SafeLinksForTeamsIsEnabled")&&this.Ra.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(B,"Electron"))return!1}else if(Array.contains(B,H.a.yva))return!1;return"officecomhwa"===(this.Ra.Va(e.AFrameworkApplication.P$)||"").toLowerCase()?!1:!0}XWj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.Ra.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&H.a.f1?!0:H.a.wC}PWj(){let B;B=0;const E=this.Xxa(),I=E?E.IsSafeLinksEnabled:
"";if(""!==I)return E.WasServiceDown?(f.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===I.toLowerCase()?(f.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:L.nMd(I),state:B};if(this.WYb)return B=3,f.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:B};if(this.UGa>=this.v_b||this.VGa>=this.w_b)return B=2,f.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",
this.UGa,this.v_b,this.VGa,this.w_b),{returnValue:!1,state:B};f.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.v_b+this.w_b-(this.UGa+this.VGa));return{returnValue:!0,state:B}}edf(){const B=this.Xxa();return B?B.PolicyCookie:""}Aii(){const B=this.Xxa();return B?B.WebAffinitizedUrl:""}E_h(){const B=this.Xxa();return B?B.AffinitizedUrl:""}M5h(){const B=
new Date;try{const E=this.Xxa();B.setTime(E?E.PolicyCookieTTL:0)}catch(E){f.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",E)}return B}wyd(){const B=this.M5h();return!!B&&B.getTime()<Date.now()}Xxa(){if(!this.x1b){const B=t.a.instance.getItem(this.userId);if(!B||""===B)return null;this.x1b=JSON.parse(B)}return this.x1b}Jcg(B){if(void 0===B||null===B)throw Error.argumentNull("safeLinksData");if(void 0===B.IsSafeLinksEnabled||null===B.IsSafeLinksEnabled||
0>=B.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.x1b=B;B.WasServiceDown||this.nmk(B)}nmk(B){B=JSON.stringify(B);t.a.instance.setItem(this.userId,B)}Fad(B){return void 0!==L.ti&&null!==L.ti?L.ti.Fd("WebServiceCall",B):null}wGc(B){if(void 0!==B&&null!==B){const E=B.vd;B.stop();return{returnValue:E,stopwatch:null}}return{returnValue:null,stopwatch:B}}static nMd(B){return"false"!==B.toLowerCase()?!0:!1}}L.ti=null;L.DYc=null;L.Use="";L.Ute="";L.mRc="";Object(r.a)(L,
"SafeLinksManager",null,[474]);const M=B=>{switch(B){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},O=B=>{switch(B){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};(()=>{Object(b.b)(c.rb,{cy:"singleton"})(()=>new L(e.AFrameworkApplication.fa,e.AFrameworkApplication.qe,String.format("{0}-{1}",M(e.AFrameworkApplication.sa.Qa.li),O(e.AFrameworkApplication.sa.Qa.uBa))))})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSOpt.safelinks.js.map/c07fd5b8e075547c560155fec9546fb6/EwaDSOpt.safelinks.js.map